<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ’§ AFS Cloud Monitor Visual</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Montserrat", sans-serif;
      background: linear-gradient(180deg, #1e88e5, #64b5f6);
      color: #0d47a1;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      color: white;
      margin-top: 25px;
      font-weight: 700;
    }
    #estadoIoT {
      font-weight: 600;
      margin-bottom: 20px;
      color: white;
    }
    .panel {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 40px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 10px rgba(0,0,0,0.15);
      width: 280px;
      padding: 15px;
      transition: 0.3s;
    }
    .card:hover {
      transform: scale(1.02);
    }
    canvas {
      width: 220px !important;
      height: 120px !important;
    }
    .valor {
      font-size: 1.6em;
      font-weight: 700;
      color: #1565c0;
    }
  </style>
</head>

<body>
  <h1>ðŸ’§ AFS Cloud Monitor Visual</h1>
  <div id="estadoIoT">ðŸ•“ Conectando...</div>

  <div class="panel">
    <div class="card">
      <h3>Nivel de Agua (%)</h3>
      <canvas id="nivel"></canvas>
      <div class="valor" id="nivelValor">0.00</div>
    </div>
    <div class="card">
      <h3>Caudal (L/s)</h3>
      <canvas id="caudal"></canvas>
      <div class="valor" id="caudalValor">0.00</div>
    </div>
    <div class="card">
      <h3>Eficiencia HÃ­drica (%)</h3>
      <canvas id="eficiencia"></canvas>
      <div class="valor" id="eficienciaValor">0.00</div>
    </div>
    <div class="card">
      <h3>Balance HÃ­drico (L)</h3>
      <canvas id="balance"></canvas>
      <div class="valor" id="balanceValor">0.00</div>
    </div>
    <div class="card">
      <h3>Lluvia (mm/h)</h3>
      <canvas id="lluvia"></canvas>
      <div class="valor" id="lluviaValor">0.00</div>
    </div>
  </div>

  <script>
    // Configurar medidores semicirculares
    const gaugeConfig = (color) => ({
      type: "doughnut",
      data: {
        datasets: [{
          data: [0, 100],
          backgroundColor: [color, "#e0e0e0"],
          borderWidth: 0,
          cutout: "80%",
          rotation: -90,
          circumference: 180
        }]
      },
      options: { plugins: { tooltip: { enabled: false }, legend: { display: false } } }
    });

    const gauges = {
      nivel: new Chart(document.getElementById("nivel"), gaugeConfig("#1565c0")),
      caudal: new Chart(document.getElementById("caudal"), gaugeConfig("#42a5f5")),
      eficiencia: new Chart(document.getElementById("eficiencia"), gaugeConfig("#00bfa5")),
      balance: new Chart(document.getElementById("balance"), gaugeConfig("#5e35b1")),
      lluvia: new Chart(document.getElementById("lluvia"), gaugeConfig("#0288d1"))
    };

    async function actualizarDatos() {
      try {
        const res = await fetch("https://afscloudmonitor.onrender.com/data", {
          cache: "no-store"
        });
        const d = await res.json();
        document.getElementById("estadoIoT").innerHTML = "ðŸŸ¢ Conectado";

        const datos = {
          nivel: d.nivel_agua ?? 0,
          caudal: d.caudal ?? 0,
          eficiencia: d.eficiencia ?? 0,
          balance: d.balance_hidrico ?? 0,
          lluvia: d.lluvia ?? 0
        };

        Object.entries(datos).forEach(([k, v]) => {
          const gauge = gauges[k];
          if (gauge) {
            gauge.data.datasets[0].data[0] = Math.min(v, 100);
            gauge.data.datasets[0].data[1] = 100 - Math.min(v, 100);
            gauge.update();
          }
          const val = document.getElementById(`${k}Valor`);
          if (val) val.textContent = v.toFixed(2);
        });

      } catch (err) {
        console.error("Error al obtener datos:", err);
        document.getElementById("estadoIoT").innerHTML = "ðŸ”´ Desconectado";
      }
    }

    // Ejecutar cada 5 segundos
    setInterval(actualizarDatos, 5000);
    actualizarDatos();
  </script>
</body>
</html>

